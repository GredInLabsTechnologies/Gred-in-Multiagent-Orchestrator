============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-9.0.2, pluggy-1.6.0 -- C:\Python314\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\shilo\Documents\GitHub\gred_orchestrator
plugins: anyio-4.12.1, cov-7.0.0
collecting ... collected 24 items

tests/test_api_open_repo.py::test_api_open_repo_decoupled PASSED         [  4%]
tests/test_api_td002.py::test_api_service_status FAILED                  [  8%]
tests/test_api_td002.py::test_api_service_restart FAILED                 [ 12%]
tests/test_api_td002.py::test_api_service_stop FAILED                    [ 16%]
tests/test_api_td002.py::test_api_vitaminize_invalid_path FAILED         [ 20%]
tests/test_api_td002.py::test_api_vitaminize_success FAILED              [ 25%]
tests/test_fuzzing.py::test_endpoint_fuzzing PASSED                      [ 29%]
tests/test_fuzzing.py::test_null_byte_injections PASSED                  [ 33%]
tests/test_integrity_deep.py::test_critical_file_integrity PASSED        [ 37%]
tests/test_integrity_deep.py::test_environment_entropy PASSED            [ 41%]
tests/test_integrity_deep.py::test_orphan_dependency_check PASSED        [ 45%]
tests/test_security_hardened.py::test_auth_rejection_triggers_panic PASSED [ 50%]
tests/test_security_hardened.py::test_panic_mode_isolation PASSED        [ 54%]
tests/test_security_hardened.py::test_path_traversal_shield_exhaustive FAILED [ 58%]
tests/test_security_hardened.py::test_redaction_rigor PASSED             [ 62%]
tests/test_security_hardened.py::test_rate_limiting_functional PASSED    [ 66%]
tests/test_unit_security.py::test_normalize_path_traversal PASSED        [ 70%]
tests/test_unit_security.py::test_normalize_path_valid PASSED            [ 75%]
tests/test_unit_security.py::test_validate_path_denied PASSED            [ 79%]
tests/test_unit_security.py::test_security_redaction PASSED              [ 83%]
tests/test_unit_system_service.py::TestSystemService::test_get_status_headless PASSED [ 87%]
tests/test_unit_system_service.py::TestSystemService::test_get_status_running PASSED [ 91%]
tests/test_unit_system_service.py::TestSystemService::test_restart_service_success PASSED [ 95%]
tests/test_unit_system_service.py::TestSystemService::test_stop_service_success PASSED [100%]
tests/test_unit_system_service.py::TestSystemService::test_stop_service_success ERROR [100%]

=================================== ERRORS ====================================
______ ERROR at teardown of TestSystemService.test_stop_service_success _______
tests\conftest.py:19: in test_client
    with client:
         ^^^^^^
..\..\..\AppData\Roaming\Python\Python314\site-packages\starlette\testclient.py:699: in __exit__
    self.exit_stack.close()
C:\Python314\Lib\contextlib.py:627: in close
    self.__exit__(None, None, None)
C:\Python314\Lib\contextlib.py:619: in __exit__
    raise exc
C:\Python314\Lib\contextlib.py:604: in __exit__
    if cb(*exc_details):
       ^^^^^^^^^^^^^^^^
C:\Python314\Lib\contextlib.py:482: in _exit_wrapper
    callback(*args, **kwds)
..\..\..\AppData\Roaming\Python\Python314\site-packages\starlette\testclient.py:692: in wait_shutdown
    portal.call(self.wait_shutdown)
..\..\..\AppData\Roaming\Python\Python314\site-packages\anyio\from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Python314\Lib\concurrent\futures\_base.py:450: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Python314\Lib\concurrent\futures\_base.py:395: in __get_result
    raise self._exception
..\..\..\AppData\Roaming\Python\Python314\site-packages\anyio\from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Roaming\Python\Python314\site-packages\starlette\testclient.py:739: in wait_shutdown
    await receive()
..\..\..\AppData\Roaming\Python\Python314\site-packages\starlette\testclient.py:729: in receive
    self.task.result()
C:\Python314\Lib\concurrent\futures\_base.py:441: in result
    raise CancelledError()
E   concurrent.futures._base.CancelledError
------------------------------ Captured log call ------------------------------
INFO     root:audit.py:42 OP:READ | PATH:SYSTEM | RANGE:STOP_SERVICE_TestService | HASH:STARTING | ACTOR:tester
INFO     root:audit.py:42 OP:READ | PATH:SYSTEM | RANGE:STOP_SERVICE_TestService | HASH:SUCCESS | ACTOR:tester
---------------------------- Captured log teardown ----------------------------
INFO     orchestrator:main.py:44 Shutting down Repo Orchestrator...
================================== FAILURES ===================================
___________________________ test_api_service_status ___________________________
tests\test_api_td002.py:30: in test_api_service_status
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/ui/service/status "HTTP/1.1 401 Unauthorized"
__________________________ test_api_service_restart ___________________________
tests\test_api_td002.py:37: in test_api_service_restart
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/ui/service/restart "HTTP/1.1 401 Unauthorized"
____________________________ test_api_service_stop ____________________________
tests\test_api_td002.py:45: in test_api_service_stop
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/ui/service/stop "HTTP/1.1 401 Unauthorized"
______________________ test_api_vitaminize_invalid_path _______________________
tests\test_api_td002.py:51: in test_api_vitaminize_invalid_path
    assert response.status_code == 400
E   assert 401 == 400
E    +  where 401 = <Response [401 Unauthorized]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/ui/repos/vitaminize?path=C:/outside "HTTP/1.1 401 Unauthorized"
_________________________ test_api_vitaminize_success _________________________
tests\test_api_td002.py:64: in test_api_vitaminize_success
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/ui/repos/vitaminize?path=/mock/repos/myrepo "HTTP/1.1 401 Unauthorized"
____________________ test_path_traversal_shield_exhaustive ____________________
tests\test_security_hardened.py:73: in test_path_traversal_shield_exhaustive
    validate_path(path, base_dir)
tools\repo_orchestrator\security\validation.py:70: in validate_path
    raise HTTPException(status_code=403, detail="Access denied: Path traversal detected or invalid path.")
E   fastapi.exceptions.HTTPException: 403: Access denied: Path traversal detected or invalid path.
=========================== short test summary info ===========================
FAILED tests/test_api_td002.py::test_api_service_status - assert 401 == 200
FAILED tests/test_api_td002.py::test_api_service_restart - assert 401 == 200
FAILED tests/test_api_td002.py::test_api_service_stop - assert 401 == 200
FAILED tests/test_api_td002.py::test_api_vitaminize_invalid_path - assert 401...
FAILED tests/test_api_td002.py::test_api_vitaminize_success - assert 401 == 200
FAILED tests/test_security_hardened.py::test_path_traversal_shield_exhaustive
ERROR tests/test_unit_system_service.py::TestSystemService::test_stop_service_success
==================== 6 failed, 18 passed, 1 error in 0.96s ====================
