============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\shilo\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\shilo\Documents\GitHub\Gred-Repo-Orchestrator
plugins: anyio-4.10.0, asyncio-1.1.0, cov-6.2.1
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_api_open_repo.py::test_api_open_repo_decoupled FAILED         [100%]

================================== FAILURES ===================================
________________________ test_api_open_repo_decoupled _________________________

mock_popen = <MagicMock name='Popen' id='3142201014320'>
mock_audit = <MagicMock name='audit_log' id='3142199156352'>
test_client = <starlette.testclient.TestClient object at 0x000002DB99D0ED20>

    @patch('tools.repo_orchestrator.routes.REPO_ROOT_DIR', new=Path("/mock/repos"))
    @patch('tools.repo_orchestrator.routes.audit_log')
    @patch('subprocess.Popen')
    def test_api_open_repo_decoupled(mock_popen, mock_audit, test_client):
        """
        Verifies that open_repo is decoupled:
        1. Returns 200 OK.
        2. Logs the event.
        3. NEVER calls subprocess.Popen.
        """
        repo_path_str = "/mock/repos/myrepo"
    
        # Mock pathlib.Path.exists and resolve directly
        with patch('pathlib.Path.exists', return_value=True):
            with patch('pathlib.Path.resolve', return_value=Path(repo_path_str)):
                # conftest.py sets ORCH_TOKEN to a specific test value
                token = os.environ.get("ORCH_TOKEN", "test-token-a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0")
                headers = {"Authorization": f"Bearer {token}"}
                response = test_client.post(f"/ui/repos/open?path={repo_path_str}", headers=headers)
    
>               assert response.status_code == 200
E               assert 503 == 200
E                +  where 503 = <Response [503 Service Unavailable]>.status_code

tests\test_api_open_repo.py:40: AssertionError
----------------------------- Captured log setup ------------------------------
INFO     orchestrator:main.py:35 Starting Repo Orchestrator...
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/ui/repos/open?path=/mock/repos/myrepo "HTTP/1.1 503 Service Unavailable"
---------------------------- Captured log teardown ----------------------------
INFO     orchestrator:main.py:52 Shutting down Repo Orchestrator...
=========================== short test summary info ===========================
FAILED tests/test_api_open_repo.py::test_api_open_repo_decoupled - assert 503...
============================== 1 failed in 0.41s ==============================
